name: Guardian Auto Merge

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  guardian_check:
    runs-on: ubuntu-latest

    steps:
    - name: Check out
      uses: actions/checkout@v4

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Parse PR body for Guardian coherence score
      id: parse
      run: |
        echo "BODY<<EOF" >> $GITHUB_OUTPUT
        echo "${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        SCORE=$(echo "${{ github.event.pull_request.body }}" | grep -o "coherence_score: [0-9.]*" | awk '{print $2}')
        echo "score=$SCORE" >> $GITHUB_OUTPUT

    - name: Validate score exists (skip for infrastructure PRs)
      id: validate_score
      run: |
        if [[ -z "${{ steps.parse.outputs.score }}" ]]; then
          echo "no_score=true" >> $GITHUB_OUTPUT
        else
          echo "no_score=false" >> $GITHUB_OUTPUT
        fi

    - name: Validate score >= 0.8 (skip unless score exists)
      if: steps.validate_score.outputs.no_score == 'false'
      run: |
        if (( $(echo "${{ steps.parse.outputs.score }} < 0.8" | bc -l) )); then
          echo "Guardian coherence score too low."
          exit 1
        fi

    - name: Verify allowed paths only
      run: |
        while read -r file; do
          if [[ "$file" != docs/* && "$file" != sovereign_architecture/* ]]; then
            echo "Unauthorized file change detected: $file"
            exit 1
          fi
        done <<< "$(gh pr view ${{ github.event.pull_request.number }} --json files -q '.files[].path')"

    - name: Add guardian-approved label
      uses: actions-ecosystem/action-add-labels@v1
      with:
        labels: guardian-approved

    - name: Enable auto-merge
      if: steps.validate_score.outputs.no_score == 'false'
      run: gh pr merge ${{ github.event.pull_request.number }} --squash --auto
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
