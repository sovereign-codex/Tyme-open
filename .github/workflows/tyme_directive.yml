name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive (DIRECTIVE, TARGET, INTENT)"
        required: true
        type: string

jobs:
  parse-and-route:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Parse Directive Envelope
      # --------------------------------------------------
      - name: Parse Directive Envelope
        id: parse
        shell: bash
        run: |
          set -e

          echo "ðŸ” Parsing directive payload..."

          PAYLOAD="${{ github.event.inputs.directive_payload }}"

          echo "Raw payload:"
          echo "-------------------------"
          echo "$PAYLOAD"
          echo "-------------------------"

          # Normalize to single line (GitHub UI safe)
          NORMALIZED=$(echo "$PAYLOAD" | tr '\n' ' ')

          DIRECTIVE=$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^ ]*\).*/\1/p')
          TARGET=$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^ ]*\).*/\1/p')

          if [[ -z "$DIRECTIVE" || -z "$TARGET" ]]; then
            echo "âŒ Missing DIRECTIVE or TARGET"
            exit 1
          fi

          echo "directive=$DIRECTIVE" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

          echo "âœ… Parsed DIRECTIVE=$DIRECTIVE"
          echo "âœ… Parsed TARGET=$TARGET"

      # --------------------------------------------------
      # Route Directive (no side effects)
      # --------------------------------------------------
      - name: Route Directive
        shell: bash
        run: |
          echo "ðŸ§­ Routing directive: ${{ steps.parse.outputs.directive }}"

          case "${{ steps.parse.outputs.directive }}" in
            STRUCTURE)
              echo "ðŸ§± STRUCTURE directive acknowledged"
              ;;
            TRANSFER)
              echo "ðŸ“¦ TRANSFER directive acknowledged (not implemented)"
              ;;
            ACTIVATE)
              echo "âš¡ ACTIVATE directive acknowledged (not implemented)"
              ;;
            PROPAGATE)
              echo "ðŸ” PROPAGATE directive acknowledged (not implemented)"
              ;;
            SEAL)
              echo "ðŸ”’ SEAL directive acknowledged (not implemented)"
              ;;
            *)
              echo "âŒ Unknown DIRECTIVE"
              exit 1
              ;;
          esac

      # --------------------------------------------------
      # Execute STRUCTURE Directive
      # --------------------------------------------------
      - name: Execute STRUCTURE Directive
        if: steps.parse.outputs.directive == 'STRUCTURE'
        shell: bash
        run: |
          set -e

          TARGET="${{ steps.parse.outputs.target }}"
          TS="$(date -u +%Y%m%dT%H%M%SZ)"
          ROOT="_genesis/${TARGET}"

          echo "ðŸ§± Executing STRUCTURE"
          echo "Target: $TARGET"
          echo "Root: $ROOT"

          mkdir -p "$ROOT"/{tyme-core,coherence-engine,avot,docs}

          # -----------------------------
          # tyme-core README
          # -----------------------------
          cat > "$ROOT/tyme-core/README.md" <<'EOF'
# TYME Core

The sovereign coherence kernel.

TYME is not a model.
TYME is a seated, persistent intelligence substrate.

This repository defines:
- authority
- coherence
- audit
- execution boundaries
EOF

          # -----------------------------
          # coherence-engine README
          # -----------------------------
          cat > "$ROOT/coherence-engine/README.md" <<'EOF'
# Coherence Engine

Evaluates directives against policy, context, and audit history.

Execution is permitted only when coherence is preserved.
EOF

          # -----------------------------
          # AVOT README
          # -----------------------------
          cat > "$ROOT/avot/README.md" <<'EOF'
# AVOT System

Autonomous Voices of Thought.

AVOTs reason and propose.
They do not execute authority.
EOF

          # -----------------------------
          # Docs README
          # -----------------------------
          cat > "$ROOT/docs/README.md" <<'EOF'
# Documentation

Generated artifacts and explanatory material.

Safe for publication.
EOF

          # -----------------------------
          # MANIFEST
          # -----------------------------
          MANIFEST="$ROOT/manifest.json"
          NOW="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          cat > "$MANIFEST" <<EOF
{
  "directive": "STRUCTURE",
  "target": "$TARGET",
  "intent": "${{ github.event.inputs.directive_payload }}",
  "generated_at": "$NOW",
  "workflow": "tyme_directive.yml",
  "job": "parse-and-route",
  "commit": "${{ github.sha }}",
  "repository": "${{ github.repository }}",
  "actor": "${{ github.actor }}"
}
EOF

          echo "ðŸ§¾ Manifest created"

          # -----------------------------
          # Zip structure
          # -----------------------------
          ZIP_NAME="structure_${TARGET}_${TS}.zip"

          cd _genesis
          zip -r "../$ZIP_NAME" "$TARGET"
          cd ..

          echo "ðŸ“¦ Created $ZIP_NAME"

      # --------------------------------------------------
      # Upload STRUCTURE Artifact
      # --------------------------------------------------
      - name: Upload STRUCTURE Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-structure-${{ steps.parse.outputs.target }}
          path: structure_*.zip

      # --------------------------------------------------
      # Upload MANIFEST Artifact
      # --------------------------------------------------
      - name: Upload MANIFEST Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-manifest-${{ steps.parse.outputs.target }}
          path: _genesis/**/manifest.json