name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive (DIRECTIVE, TARGET, INTENT)"
        required: true
        type: string

jobs:
  parse-and-route:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Directive Envelope
  id: parse
  shell: bash
  run: |
    echo "Parsing directive payload..."

    PAYLOAD="${{ github.event.inputs.directive_payload }}"

    echo "Raw payload:"
    echo "----------------"
    echo "$PAYLOAD"
    echo "----------------"

    # Normalize payload into single line for token extraction
    NORMALIZED=$(echo "$PAYLOAD" | tr '\n' ' ')

    DIRECTIVE=$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^ ]*\).*/\1/p')
    TARGET=$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^ ]*\).*/\1/p')

    if [[ -z "$DIRECTIVE" || -z "$TARGET" ]]; then
      echo "‚ùå Missing DIRECTIVE or TARGET"
      exit 1
    fi

    echo "directive=$DIRECTIVE" >> $GITHUB_OUTPUT
    echo "target=$TARGET" >> $GITHUB_OUTPUT

    echo "‚úÖ Parsed DIRECTIVE=$DIRECTIVE"
    echo "‚úÖ Parsed TARGET=$TARGET"

        - name: Route Directive
        run: |
          echo "Routing directive..."

          case "${{ steps.parse.outputs.directive }}" in

            STRUCTURE)
              echo "üß± STRUCTURE directive received"
              # call structure script or generator
              ;;
            
            TRANSFER)
              echo "üì¶ TRANSFER directive received"
              ;;
            
            ACTIVATE)
              echo "‚ö° ACTIVATE directive received"
              ;;
            
            PROPAGATE)
              echo "üîÅ PROPAGATE directive received"
              ;;
            
            SEAL)
              echo "üîí SEAL directive received"
              ;;
            
            *)
              echo "‚ùå Unknown DIRECTIVE"
              exit 1
              ;;
          esac
