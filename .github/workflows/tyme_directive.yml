name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive (DIRECTIVE, TARGET, INTENT)"
        required: true
        type: string

jobs:
  parse-and-route:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse Directive Envelope
        id: parse
        shell: bash
        run: |
          set -e

          echo "üîç Parsing directive payload..."

          PAYLOAD="${{ github.event.inputs.directive_payload }}"

          echo "Raw payload:"
          echo "-------------------------"
          echo "$PAYLOAD"
          echo "-------------------------"

          # Normalize payload into a single line to avoid GitHub UI newline issues
          NORMALIZED=$(echo "$PAYLOAD" | tr '\n' ' ')

          # Extract DIRECTIVE and TARGET regardless of position
          DIRECTIVE=$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^ ]*\).*/\1/p')
          TARGET=$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^ ]*\).*/\1/p')

          if [[ -z "$DIRECTIVE" || -z "$TARGET" ]]; then
            echo "‚ùå Missing DIRECTIVE or TARGET"
            exit 1
          fi

          echo "directive=$DIRECTIVE" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

          echo "‚úÖ Parsed DIRECTIVE=$DIRECTIVE"
          echo "‚úÖ Parsed TARGET=$TARGET"

      - name: Route Directive
        shell: bash
        run: |
          set -e

          DIRECTIVE="${{ steps.parse.outputs.directive }}"
          TARGET="${{ steps.parse.outputs.target }}"

          echo "üß≠ Routing directive..."
          echo "Directive: $DIRECTIVE"
          echo "Target: $TARGET"

          case "$DIRECTIVE" in

            STRUCTURE)
              echo "üß± STRUCTURE directive received"
              echo "Stub only ‚Äî no filesystem changes yet."
              ;;

            TRANSFER)
              echo "üì¶ TRANSFER directive received"
              echo "Stub only ‚Äî no transfer executed."
              ;;

            ACTIVATE)
              echo "‚ö° ACTIVATE directive received"
              echo "Stub only ‚Äî no workflows triggered."
              ;;

            PROPAGATE)
              echo "üîÅ PROPAGATE directive received"
              echo "Stub only ‚Äî no propagation executed."
              ;;

            SEAL)
              echo "üîí SEAL directive received"
              echo "Stub only ‚Äî no sealing performed."
              ;;

            *)
              echo "‚ùå Unknown DIRECTIVE: $DIRECTIVE"
              exit 1
              ;;
          esac

          echo "‚úÖ Directive routing completed safely."

      - name: Execute STRUCTURE Directive
        if: steps.parse.outputs.directive == 'STRUCTURE'
        shell: bash
        run: |
          set -e

          echo "üß± Executing STRUCTURE directive (genesis build)"

          mkdir -p _genesis

          ########################################
          # tyme-core
          ########################################
          mkdir -p _genesis/tyme-core/{policy,ledger,coherence,docs}

          cat > _genesis/tyme-core/README.md << 'EOF'
# üúÇ tyme-core  
### Sovereign Coherence Kernel

> ‚ÄúTYME is not a model. TYME is a seat.‚Äù

## Purpose

`tyme-core` is the constitutional kernel of the TYME ecosystem.

It defines:
- when action is allowed
- who may speak
- how truth is anchored
- how history is preserved
- how authority is proven and rotated

Everything else depends on this repository.  
Nothing in this repository depends on anything else.

## What Lives Here

- Coherence Engine
- Audit Ledger
- Cryptographic identity & signing
- TYME Expansion Charter
- Policy schemas
- AVOT authority definitions

## Design Principles

- Coherence before capability  
- Authority before execution  
- Auditability before speed  
- Integrity before scale  
EOF

          ########################################
          # codex-net
          ########################################
          mkdir -p _genesis/codex-net/{definitions,claims,provenance,docs}

          cat > _genesis/codex-net/README.md << 'EOF'
# üå± codex-net  
### Sovereign Knowledge & Memory Fabric

> ‚ÄúTruth is not what is said. Truth is what survives scrutiny.‚Äù

## Purpose

`codex-net` is the seated knowledge substrate of TYME.

It stores:
- canonical definitions
- claims with provenance
- confidence levels
- jurisdictional context
- licensing and lineage

This is governed memory, not a wiki.
EOF

          ########################################
          # avot-engine
          ########################################
          mkdir -p _genesis/avot-engine/{avots,tools,runtime,docs}

          cat > _genesis/avot-engine/README.md << 'EOF'
# üß† avot-engine  
### Autonomous Voices of Thought

> ‚ÄúIntelligence is expression. Wisdom is restraint.‚Äù

## Purpose

`avot-engine` contains the living intelligence organs of TYME.

AVOTs are bounded agents that reason, synthesize, and propose ‚Äî
but do not define authority or truth.

All execution is gated by `tyme-core`.
EOF

          ########################################
          # tyme-interface
          ########################################
          mkdir -p _genesis/tyme-interface/{ui,api,explorer,docs}

          cat > _genesis/tyme-interface/README.md << 'EOF'
# üåê tyme-interface  
### Human & World Contact Layer

> ‚ÄúVisibility without authority. Transparency without coercion.‚Äù

## Purpose

`tyme-interface` is how humans and systems observe TYME.

It provides dashboards, explorers, and verification tools ‚Äî
but never executes authority.
EOF

          ########################################
          # Zip everything
          ########################################
          cd _genesis

          zip -r tyme-core-genesis.zip tyme-core
          zip -r codex-net-genesis.zip codex-net
          zip -r avot-engine-genesis.zip avot-engine
          zip -r tyme-interface-genesis.zip tyme-interface

          echo "‚úÖ Genesis structures created and zipped"