name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive Envelope (e.g. DIRECTIVE: STRUCTURE TARGET: core)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  tyme-directive:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Parse Directive Envelope
      # --------------------------------------------------
      - name: Parse Directive
        id: parse
        shell: bash
        run: |
          set -e

          PAYLOAD="${{ github.event.inputs.directive_payload }}"
          NORMALIZED=$(echo "$PAYLOAD" | tr '\n' ' ')

          DIRECTIVE=$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^[:space:]]*\).*/\1/p')
          TARGET=$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^[:space:]]*\).*/\1/p')

          if [[ -z "$DIRECTIVE" ]]; then
            echo "âŒ Missing DIRECTIVE"
            exit 1
          fi

          echo "directive=$DIRECTIVE" >> "$GITHUB_OUTPUT"
          echo "target=${TARGET:-default}" >> "$GITHUB_OUTPUT"

          echo "âœ… DIRECTIVE=$DIRECTIVE"
          echo "âœ… TARGET=${TARGET:-default}"

      # --------------------------------------------------
      # STRUCTURE Directive
      # --------------------------------------------------
      - name: Execute STRUCTURE
        if: steps.parse.outputs.directive == 'STRUCTURE'
        shell: bash
        run: |
          set -e

          ROOT="_genesis/structure"
          mkdir -p "$ROOT/tyme-core" "$ROOT/tyme-interface" "$ROOT/tyme-directives"

          cat > "$ROOT/tyme-core/README.md" <<'EOF'
          # tyme-core
          Sovereign coherence kernel.
          No UI. No execution authority.
          EOF

          cat > "$ROOT/tyme-interface/README.md" <<'EOF'
          # tyme-interface
          Human-facing dashboards.
          Never executes authority.
          EOF

          cat > "$ROOT/tyme-directives/README.md" <<'EOF'
          # tyme-directives
          Declarative intent envelopes.
          Parsed, validated, routed â€” never executed directly.
          EOF

          cd _genesis
          zip -r "structure_${{ steps.parse.outputs.target }}.zip" structure

      # --------------------------------------------------
      # MANIFEST Directive
      # --------------------------------------------------
      - name: Execute MANIFEST
        if: steps.parse.outputs.directive == 'MANIFEST'
        shell: bash
        run: |
          set -e

          ROOT="_genesis/manifest"
          mkdir -p "$ROOT"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > "$ROOT/manifest.json" <<EOF
          {
            "system": "TYME",
            "directive": "MANIFEST",
            "target": "${{ steps.parse.outputs.target }}",
            "generated_at": "$TIMESTAMP",
            "principles": [
              "no implicit authority",
              "artifacts over commits",
              "deterministic execution",
              "human-verifiable output"
            ]
          }
          EOF

      # --------------------------------------------------
      # SIGN Artifacts (STRUCTURE or MANIFEST)
      # --------------------------------------------------
      - name: Sign Artifacts
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'MANIFEST'
        shell: bash
        run: |
          set -e

          mkdir -p _genesis/signatures
          TARGET="${{ steps.parse.outputs.target }}"

          if [[ "${{ steps.parse.outputs.directive }}" == "STRUCTURE" ]]; then
            ARTIFACT="_genesis/structure_${TARGET}.zip"
            TYPE="structure"
          else
            ARTIFACT="_genesis/manifest/manifest.json"
            TYPE="manifest"
          fi

          HASH=$(sha256sum "$ARTIFACT" | awk '{print $1}')

          cat > "_genesis/signatures/${TYPE}_${TARGET}.sig.json" <<EOF
          {
            "type": "$TYPE",
            "target": "$TARGET",
            "algorithm": "sha256",
            "hash": "$HASH",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      # --------------------------------------------------
      # Upload Artifacts
      # --------------------------------------------------
      - name: Upload STRUCTURE Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-structure-${{ steps.parse.outputs.target }}
          path: _genesis/structure_*.zip

      - name: Upload MANIFEST Artifact
        if: steps.parse.outputs.directive == 'MANIFEST'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-manifest-${{ steps.parse.outputs.target }}
          path: _genesis/manifest/manifest.json

      - name: Upload SIGNATURE Artifacts
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'MANIFEST'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-signatures-${{ steps.parse.outputs.target }}
          path: _genesis/signatures/*.sig.json
          if-no-files-found: warn

      # --------------------------------------------------
      # COMMIT Directive (explicit, gated)
      # --------------------------------------------------
      - name: Execute COMMIT
        if: steps.parse.outputs.directive == 'COMMIT'
        shell: bash
        run: |
          set -e

          echo "ðŸ§¾ COMMIT directive invoked"

          git config user.name "tyme-bot"
          git config user.email "actions@github.com"

          git add _genesis || true

          if git diff --cached --quiet; then
            echo "âš ï¸ Nothing to commit"
            exit 0
          fi

          git commit -m "TYME COMMIT: materialized artifacts"
          git push origin HEAD:${{ github.ref_name }}