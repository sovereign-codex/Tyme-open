name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive Envelope (e.g. DIRECTIVE: STRUCTURE TARGET: core)"
        required: true
        type: string

# Needed for COMMIT to push back to the repo.
permissions:
  contents: write

concurrency:
  group: tyme-directive-${{ github.ref }}
  cancel-in-progress: false

jobs:
  parse-and-execute:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Parse Directive Envelope
      # --------------------------------------------------
      - name: Parse Directive Envelope
        id: parse
        shell: bash
        run: |
          set -euo pipefail

          echo "Parsing directive payload..."
          PAYLOAD="${{ github.event.inputs.directive_payload }}"
          NORMALIZED="$(echo "$PAYLOAD" | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g' | sed 's/^ //; s/ $//')"

          # Extract fields
          DIRECTIVE_RAW="$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^[:space:]]*\).*/\1/p' || true)"
          TARGET_RAW="$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^[:space:]]*\).*/\1/p' || true)"

          if [[ -z "${DIRECTIVE_RAW}" ]]; then
            echo "âŒ Missing DIRECTIVE in payload"
            echo "Payload was: $NORMALIZED"
            exit 1
          fi

          # Normalize directive to UPPERCASE
          DIRECTIVE="$(echo "$DIRECTIVE_RAW" | tr '[:lower:]' '[:upper:]')"

          # Default target
          TARGET="${TARGET_RAW:-core}"

          # Sanitize target to a safe slug: lowercase, keep [a-z0-9-], convert others to '-'
          TARGET_SLUG="$(echo "$TARGET" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's/[^a-z0-9-]/-/g' \
            | sed 's/--\+/-/g' \
            | sed 's/^-//; s/-$//' )"

          if [[ -z "${TARGET_SLUG}" ]]; then
            TARGET_SLUG="core"
          fi

          echo "directive=$DIRECTIVE" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"
          echo "target_slug=$TARGET_SLUG" >> "$GITHUB_OUTPUT"

          echo "âœ… DIRECTIVE=$DIRECTIVE"
          echo "âœ… TARGET=$TARGET"
          echo "âœ… TARGET_SLUG=$TARGET_SLUG"

      # --------------------------------------------------
      # STRUCTURE Directive (runs for STRUCTURE and COMMIT)
      # --------------------------------------------------
      - name: Execute STRUCTURE
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'COMMIT'
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ“¦ Executing STRUCTURE directive"

          ROOT="_genesis/structure"
          mkdir -p "$ROOT/tyme-core" "$ROOT/tyme-interface" "$ROOT/tyme-directives"

          cat > "$ROOT/tyme-core/README.md" <<'EOF'
          # tyme-core
          Sovereign coherence kernel.
          No UI. No execution authority.
          EOF

          cat > "$ROOT/tyme-interface/README.md" <<'EOF'
          # tyme-interface
          Human-facing dashboards and explorers.
          Never executes authority.
          EOF

          cat > "$ROOT/tyme-directives/README.md" <<'EOF'
          # tyme-directives
          Declarative intent envelopes.
          Parsed, validated, routed â€” never executed directly.
          EOF

          (cd _genesis && zip -r "structure_${{ steps.parse.outputs.target_slug }}.zip" structure)

      - name: Sign STRUCTURE Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'COMMIT'
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ” Signing STRUCTURE artifact"

          ARTIFACT="_genesis/structure_${{ steps.parse.outputs.target_slug }}.zip"
          SIG_DIR="_genesis/signatures"
          mkdir -p "$SIG_DIR"

          HASH="$(sha256sum "$ARTIFACT" | awk '{print $1}')"

          cat > "$SIG_DIR/structure_${{ steps.parse.outputs.target_slug }}.sig.json" <<EOF
          {
            "type": "structure",
            "target": "${{ steps.parse.outputs.target }}",
            "target_slug": "${{ steps.parse.outputs.target_slug }}",
            "algorithm": "sha256",
            "hash": "$HASH",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      # --------------------------------------------------
      # MANIFEST Directive (runs for MANIFEST and COMMIT)
      # --------------------------------------------------
      - name: Execute MANIFEST
        if: steps.parse.outputs.directive == 'MANIFEST' || steps.parse.outputs.directive == 'COMMIT'
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ§¾ Executing MANIFEST directive"

          ROOT="_genesis/manifest"
          mkdir -p "$ROOT"

          TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          cat > "$ROOT/manifest.json" <<EOF
          {
            "system": "TYME",
            "directive": "MANIFEST",
            "target": "${{ steps.parse.outputs.target }}",
            "target_slug": "${{ steps.parse.outputs.target_slug }}",
            "generated_at": "$TIMESTAMP",
            "principles": [
              "no implicit authority",
              "artifacts over commits",
              "deterministic execution",
              "human-verifiable output"
            ]
          }
          EOF

      - name: Sign MANIFEST Artifact
        if: steps.parse.outputs.directive == 'MANIFEST' || steps.parse.outputs.directive == 'COMMIT'
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ” Signing MANIFEST artifact"

          ARTIFACT="_genesis/manifest/manifest.json"
          SIG_DIR="_genesis/signatures"
          mkdir -p "$SIG_DIR"

          HASH="$(sha256sum "$ARTIFACT" | awk '{print $1}')"

          cat > "$SIG_DIR/manifest_${{ steps.parse.outputs.target_slug }}.sig.json" <<EOF
          {
            "type": "manifest",
            "target": "${{ steps.parse.outputs.target }}",
            "target_slug": "${{ steps.parse.outputs.target_slug }}",
            "algorithm": "sha256",
            "hash": "$HASH",
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      # --------------------------------------------------
      # Upload Artifacts
      # --------------------------------------------------
      - name: Upload STRUCTURE Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'COMMIT'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-structure-${{ steps.parse.outputs.target_slug }}
          path: _genesis/structure_${{ steps.parse.outputs.target_slug }}.zip
          if-no-files-found: error

      - name: Upload MANIFEST Artifact
        if: steps.parse.outputs.directive == 'MANIFEST' || steps.parse.outputs.directive == 'COMMIT'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-manifest-${{ steps.parse.outputs.target_slug }}
          path: _genesis/manifest/manifest.json
          if-no-files-found: error

      - name: Upload SIGNATURE Artifacts
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'MANIFEST' || steps.parse.outputs.directive == 'COMMIT'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-signatures-${{ steps.parse.outputs.target_slug }}
          path: _genesis/signatures/*.sig.json
          if-no-files-found: warn

      # --------------------------------------------------
      # COMMIT Directive (gated)
      # - COMMIT runs the pipeline above (STRUCTURE+MANIFEST+SIGN+UPLOAD)
      # - Then canonizes by committing _genesis back into the repo
      # --------------------------------------------------
      - name: Execute COMMIT
        if: steps.parse.outputs.directive == 'COMMIT'
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ§¨ COMMIT directive invoked"
          echo "This will write artifacts into the repository under _genesis/"

          git config user.name "tyme-bot"
          git config user.email "actions@github.com"

          git status
          git add _genesis

          if git diff --cached --quiet; then
            echo "âš ï¸ Nothing to commit"
            exit 0
          fi

          TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git commit -m "TYME COMMIT: ${{
            steps.parse.outputs.target_slug
          }} @ ${TS}"

          # Push back to the same branch/ref
          git push origin HEAD:${{ github.ref_name }}