name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive (DIRECTIVE, TARGET, INTENT)"
        required: true
        type: string

jobs:
  parse-and-route:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse Directive Envelope
        id: parse
        shell: bash
        run: |
          set -e

          echo "üîç Parsing directive payload..."

          PAYLOAD="${{ github.event.inputs.directive_payload }}"

          echo "Raw payload:"
          echo "-------------------------"
          echo "$PAYLOAD"
          echo "-------------------------"

          # Normalize payload into a single line to avoid GitHub UI newline issues
          NORMALIZED=$(echo "$PAYLOAD" | tr '\n' ' ')

          # Extract DIRECTIVE and TARGET regardless of position
          DIRECTIVE=$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^ ]*\).*/\1/p')
          TARGET=$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^ ]*\).*/\1/p')

          if [[ -z "$DIRECTIVE" || -z "$TARGET" ]]; then
            echo "‚ùå Missing DIRECTIVE or TARGET"
            exit 1
          fi

          echo "directive=$DIRECTIVE" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

          echo "‚úÖ Parsed DIRECTIVE=$DIRECTIVE"
          echo "‚úÖ Parsed TARGET=$TARGET"

      - name: Route Directive
        shell: bash
        run: |
          set -e

          DIRECTIVE="${{ steps.parse.outputs.directive }}"
          TARGET="${{ steps.parse.outputs.target }}"

          echo "üß≠ Routing directive..."
          echo "Directive: $DIRECTIVE"
          echo "Target: $TARGET"

          case "$DIRECTIVE" in

            STRUCTURE)
              echo "üß± STRUCTURE directive received"
              echo "Stub only ‚Äî no filesystem changes yet."
              ;;

            TRANSFER)
              echo "üì¶ TRANSFER directive received"
              echo "Stub only ‚Äî no transfer executed."
              ;;

            ACTIVATE)
              echo "‚ö° ACTIVATE directive received"
              echo "Stub only ‚Äî no workflows triggered."
              ;;

            PROPAGATE)
              echo "üîÅ PROPAGATE directive received"
              echo "Stub only ‚Äî no propagation executed."
              ;;

            SEAL)
              echo "üîí SEAL directive received"
              echo "Stub only ‚Äî no sealing performed."
              ;;

            *)
              echo "‚ùå Unknown DIRECTIVE: $DIRECTIVE"
              exit 1
              ;;
          esac

          echo "‚úÖ Directive routing completed safely."