name: Tyme Directive Bridge

on:
  workflow_dispatch:
    inputs:
      directive_payload:
        description: "TYME Directive Envelope (e.g. DIRECTIVE: STRUCTURE TARGET: core)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  parse-and-execute:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # Checkout
      # --------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------
      # Parse Directive Envelope
      # --------------------------
      - name: Parse Directive Envelope
        id: parse
        shell: bash
        run: |
          set -e

          echo "Parsing directive payload..."
          PAYLOAD="${{ github.event.inputs.directive_payload }}"
          NORMALIZED=$(echo "$PAYLOAD" | tr '\n' ' ')

          DIRECTIVE=$(echo "$NORMALIZED" | sed -n 's/.*DIRECTIVE:[[:space:]]*\([^[:space:]]*\).*/\1/p')
          TARGET=$(echo "$NORMALIZED" | sed -n 's/.*TARGET:[[:space:]]*\([^[:space:]]*\).*/\1/p')

          if [[ -z "$DIRECTIVE" ]]; then
            echo "âŒ Missing DIRECTIVE"
            exit 1
          fi

          echo "directive=$DIRECTIVE" >> "$GITHUB_OUTPUT"
          echo "target=${TARGET:-default}" >> "$GITHUB_OUTPUT"

          echo "âœ… DIRECTIVE=$DIRECTIVE"
          echo "âœ… TARGET=${TARGET:-default}"

      # --------------------------
      # Execute STRUCTURE
      # --------------------------
      - name: Execute STRUCTURE
        if: steps.parse.outputs.directive == 'STRUCTURE'
        shell: bash
        run: |
          set -e
          echo "ðŸ“¦ Executing STRUCTURE directive"

          ROOT="_genesis/structure"
          mkdir -p "$ROOT"

          mkdir -p "$ROOT/tyme-core"
          mkdir -p "$ROOT/tyme-interface"
          mkdir -p "$ROOT/tyme-directives"

          cat > "$ROOT/tyme-core/README.md" << 'EOF'
# tyme-core
Sovereign coherence kernel.
No UI. No execution authority.
EOF

          cat > "$ROOT/tyme-interface/README.md" << 'EOF'
# tyme-interface
Human-facing dashboards and explorers.
Never executes authority.
EOF

          cat > "$ROOT/tyme-directives/README.md" << 'EOF'
# tyme-directives
Declarative intent envelopes.
Parsed, validated, routed â€” never executed directly.
EOF

          cd _genesis
          zip -r "structure_${{ steps.parse.outputs.target }}.zip" structure

      # --------------------------
      # Sign STRUCTURE Artifact
      # --------------------------
      - name: Sign STRUCTURE Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE'
        shell: bash
        run: |
          set -e

          echo "ðŸ” Signing STRUCTURE artifact"

          ARTIFACT="_genesis/structure_${{ steps.parse.outputs.target }}.zip"
          SIG_DIR="_genesis/signatures"
          mkdir -p "$SIG_DIR"

          HASH=$(sha256sum "$ARTIFACT" | awk '{print $1}')

          cat > "$SIG_DIR/structure_${{ steps.parse.outputs.target }}.sig.json" <<EOF
{
  "type": "structure",
  "target": "${{ steps.parse.outputs.target }}",
  "algorithm": "sha256",
  "hash": "$HASH",
  "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

      # --------------------------
      # Execute MANIFEST
      # --------------------------
      - name: Execute MANIFEST
        if: steps.parse.outputs.directive == 'MANIFEST'
        shell: bash
        run: |
          set -e

          echo "ðŸ§¾ Executing MANIFEST directive"
          ROOT="_genesis/manifest"
          mkdir -p "$ROOT"

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > "$ROOT/manifest.json" <<EOF
{
  "system": "TYME",
  "directive": "MANIFEST",
  "target": "${{ steps.parse.outputs.target }}",
  "generated_at": "$TIMESTAMP",
  "principles": [
    "no implicit authority",
    "artifacts over commits",
    "deterministic execution",
    "human-verifiable output"
  ]
}
EOF

      # --------------------------
      # Sign MANIFEST Artifact
      # --------------------------
      - name: Sign MANIFEST Artifact
        if: steps.parse.outputs.directive == 'MANIFEST'
        shell: bash
        run: |
          set -e

          echo "ðŸ” Signing MANIFEST artifact"

          ARTIFACT="_genesis/manifest/manifest.json"
          SIG_DIR="_genesis/signatures"
          mkdir -p "$SIG_DIR"

          HASH=$(sha256sum "$ARTIFACT" | awk '{print $1}')

          cat > "$SIG_DIR/manifest_${{ steps.parse.outputs.target }}.sig.json" <<EOF
{
  "type": "manifest",
  "target": "${{ steps.parse.outputs.target }}",
  "algorithm": "sha256",
  "hash": "$HASH",
  "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

      # --------------------------
      # Upload STRUCTURE Artifact
      # --------------------------
      - name: Upload STRUCTURE Artifact
        if: steps.parse.outputs.directive == 'STRUCTURE'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-structure-${{ steps.parse.outputs.target }}
          path: _genesis/structure_*.zip

      # --------------------------
      # Upload MANIFEST Artifact
      # --------------------------
      - name: Upload MANIFEST Artifact
        if: steps.parse.outputs.directive == 'MANIFEST'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-manifest-${{ steps.parse.outputs.target }}
          path: _genesis/manifest/manifest.json

      # --------------------------
      # Upload SIGNATURE Artifacts
      # --------------------------
      - name: Upload SIGNATURE Artifacts
        if: steps.parse.outputs.directive == 'STRUCTURE' || steps.parse.outputs.directive == 'MANIFEST'
        uses: actions/upload-artifact@v4
        with:
          name: tyme-signatures-${{ steps.parse.outputs.target }}
          path: _genesis/signatures/*.sig.json
          if-no-files-found: warn